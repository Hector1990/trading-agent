<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TradingAgents Web Console</title>
    <link rel="stylesheet" href="/static/css/style.css" />
</head>
<body>
    <div class="page">
        <nav class="top-nav">
            <span class="brand">TradingAgents Console</span>
            <div class="nav-right">
                {% if is_admin %}
                <a href="/metrics" class="text-link">ç›‘æ§é¢æ¿</a>
                <a href="/admin/users" class="text-link">ç”¨æˆ·ç®¡ç†</a>
                {% endif %}
                <span class="user-chip">ğŸ‘¤ {{ user }}</span>
                <a href="/logout" class="text-link">é€€å‡º</a>
            </div>
        </nav>
        <header class="hero">
            <div class="hero-content">
                <h1>TradingAgents Web Console</h1>
                <p>ä»¥ç°ä»£åŒ–é‡‘èç§‘æŠ€ä½“éªŒé©±åŠ¨å¤šæ™ºèƒ½ä½“è°ƒç ”ï¼Œå¿«é€Ÿç”Ÿæˆè¡Œæƒ…ã€æƒ…ç»ªã€æ–°é—»ä¸é£é™©æ´å¯Ÿã€‚</p>
            </div>
        </header>

        <main class="layout single">
            <section class="card form-card">
                <h2>å‘èµ·è°ƒç ”ä»»åŠ¡</h2>
                <form id="analysis-form" class="grid-form">
                    <div class="field">
                        <label for="market">ç›®æ ‡å¸‚åœº</label>
                        <div class="segmented">
                            {% for option in market_options %}
                            <label>
                                <input type="radio" name="market" value="{{ option.value }}" {% if loop.first %}checked{% endif %}>
                                <span>
                                    <strong>{{ option.label }}</strong>
                                    <small>{{ option.description }}</small>
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="field">
                        <label for="ticker">è‚¡ç¥¨ä»£ç </label>
                        <input id="ticker" name="ticker" type="text" placeholder="600519" required />
                    </div>

                    <div class="field">
                        <label for="analysis_date">åˆ†ææ—¥æœŸ</label>
                        <input id="analysis_date" name="analysis_date" type="date" required />
                    </div>

                    <div class="field">
                        <label>è°ƒç ”æ·±åº¦</label>
                        <select id="research_depth" name="research_depth">
                            {% for option in research_depth_options %}
                            <option value="{{ option.value }}">{{ option.label }} â€” {{ option.description }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="field">
                        <label for="llm_provider">æ¨¡å‹æä¾›å•†</label>
                        <select id="llm_provider" name="llm_provider"></select>
                        <p class="field-hint" id="llm-hint"></p>
                    </div>

                    <div class="field llm-field">
                        <label for="shallow_thinker">å¿«é€Ÿæ€è€ƒæ¨¡å‹</label>
                        <select id="shallow_thinker" name="shallow_thinker"></select>
                    </div>

                    <div class="field llm-field">
                        <label for="deep_thinker">æ·±åº¦æ€è€ƒæ¨¡å‹</label>
                        <select id="deep_thinker" name="deep_thinker"></select>
                    </div>

                    <div class="field">
                        <label>åˆ†æå›¢é˜Ÿ</label>
                        <div class="checkbox-grid">
                            {% for option in analyst_options %}
                            <label class="checkbox">
                                <input type="checkbox" name="analysts" value="{{ option.value }}" checked />
                                <span>{{ option.label }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <button type="submit" class="primary-btn">å¯åŠ¨åˆ†æ</button>
                </form>
            </section>
            <section class="card history-card">
                <div class="history-header">
                    <h2>å†å²è°ƒç ”è®°å½•</h2>
                    <button type="button" id="history-refresh" class="ghost-btn">åˆ·æ–°</button>
                </div>
                <p class="subtle">æŸ¥çœ‹ä½ è¿‘æœŸæäº¤çš„ä»»åŠ¡çŠ¶æ€ä¸ç»“è®ºã€‚</p>
                <div id="history-error" class="history-error" hidden></div>
                <div id="history-empty" class="empty-state">åŠ è½½ä¸­...</div>
                <div id="history-list" class="jobs" hidden></div>
            </section>
        </main>
    </div>

    <script>
        const llmOptions = {{ llm_options | tojson }};
        const form = document.getElementById('analysis-form');
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(form);
            const analysts = formData.getAll('analysts');
            const payload = {
                market: formData.get('market'),
                ticker: formData.get('ticker'),
                analysis_date: formData.get('analysis_date'),
                research_depth: Number(formData.get('research_depth')),
                analysts,
            };

            const providerValue = llmProviderSelect.value;
            const providerMeta = llmOptions.find(opt => opt.value === providerValue && opt.enabled);
            if (providerMeta) {
                payload.llm_provider = providerMeta.value;
                if (shallowSelect.value) {
                    payload.shallow_thinker = shallowSelect.value;
                }
                if (deepSelect.value) {
                    payload.deep_thinker = deepSelect.value;
                }
                if (providerMeta.backend_url) {
                    payload.backend_url = providerMeta.backend_url;
                }
            }

            const res = await fetch('/api/jobs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (res.status === 401) {
                window.location.href = '/login';
                return;
            }

            if (!res.ok) {
                const err = await res.json();
                alert(err.detail || 'ä»»åŠ¡æäº¤å¤±è´¥');
                return;
            }

            const job = await res.json();
            window.open(`/jobs/${job.id}`, '_blank');
        });

        // Prefill date field with today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('analysis_date').value = today;

        const llmProviderSelect = document.getElementById('llm_provider');
        const shallowSelect = document.getElementById('shallow_thinker');
        const deepSelect = document.getElementById('deep_thinker');
        const llmHint = document.getElementById('llm-hint');

        const renderSelectOptions = (selectEl, items, { disabledText = '' } = {}) => {
            selectEl.innerHTML = '';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.value;
                option.textContent = item.label;
                if (item.disabled) {
                    option.disabled = true;
                    if (disabledText) {
                        option.textContent += disabledText;
                    }
                }
                selectEl.appendChild(option);
            });
        };

        const refreshProviderOptions = () => {
            const providerItems = llmOptions.map(option => ({
                value: option.value,
                label: option.enabled ? option.label : `${option.label}ï¼ˆç¼ºå°‘ API Keyï¼‰`,
                disabled: !option.enabled,
            }));
            renderSelectOptions(llmProviderSelect, providerItems);
            llmProviderSelect.disabled = providerItems.length === 0 || providerItems.every(item => item.disabled);

            const firstEnabled = llmOptions.find(option => option.enabled);
            if (firstEnabled) {
                llmProviderSelect.value = firstEnabled.value;
            } else {
                llmProviderSelect.selectedIndex = -1;
            }
            updateModelSelects();
        };

        const updateSelectWithModels = (selectEl, models) => {
            renderSelectOptions(selectEl, models);
            if (selectEl.options.length) {
                selectEl.disabled = false;
                const preferred = models.find(model => model.default);
                selectEl.value = preferred ? preferred.value : selectEl.options[0].value;
            } else {
                selectEl.disabled = true;
            }
        };

        const updateModelSelects = () => {
            const provider = llmOptions.find(option => option.value === llmProviderSelect.value);
            if (!provider || !provider.enabled) {
                if (provider && provider.env_var) {
                    llmHint.textContent = `ç¼ºå°‘ç¯å¢ƒå˜é‡ ${provider.env_var}ï¼Œè¯·é…ç½®ååˆ·æ–°é¡µé¢ã€‚`;
                } else {
                    llmHint.textContent = 'è¯·é…ç½®å¯¹åº”çš„ API Key åå†é€‰æ‹©æ¨¡å‹ã€‚';
                }
                shallowSelect.innerHTML = '';
                deepSelect.innerHTML = '';
                shallowSelect.disabled = true;
                deepSelect.disabled = true;
                return;
            }

            llmHint.textContent = provider.description || '';

            updateSelectWithModels(shallowSelect, provider.quick_models || []);
            updateSelectWithModels(deepSelect, provider.deep_models || []);
        };

        llmProviderSelect.addEventListener('change', updateModelSelects);
        refreshProviderOptions();

        const historyList = document.getElementById('history-list');
        const historyEmpty = document.getElementById('history-empty');
        const historyError = document.getElementById('history-error');
        const historyRefresh = document.getElementById('history-refresh');

        const statusClasses = {
            queued: 'badge-queued',
            running: 'badge-running',
            completed: 'badge-success',
            failed: 'badge-failed',
        };

        const formatTimestamp = (value) => {
            if (!value) return '-';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return value;
            return date.toLocaleString();
        };

        const renderHistoryCard = (item) => {
            const card = document.createElement('div');
            card.className = 'job-card';

            const header = document.createElement('header');
            const title = document.createElement('div');
            title.innerHTML = `<strong>${item.ticker}</strong> Â· ${item.analysis_date}`;
            const badge = document.createElement('span');
            const badgeClass = statusClasses[item.status] || 'badge-queued';
            badge.className = `badge ${badgeClass}`;
            badge.textContent = item.status;
            header.appendChild(title);
            header.appendChild(badge);
            card.appendChild(header);

            const meta = document.createElement('div');
            meta.className = 'history-meta';
            meta.innerHTML = `
                <span>åˆ›å»ºï¼š${formatTimestamp(item.created_at)}</span>
                <span>æ›´æ–°ï¼š${formatTimestamp(item.updated_at)}</span>
                ${item.completed_at ? `<span>å®Œæˆï¼š${formatTimestamp(item.completed_at)}</span>` : ''}
            `;
            card.appendChild(meta);

            if (item.decision) {
                const decision = document.createElement('p');
                decision.className = 'history-decision';
                decision.textContent = item.decision;
                card.appendChild(decision);
            }

            if (item.error) {
                const error = document.createElement('p');
                error.className = 'history-error-text';
                error.textContent = item.error;
                card.appendChild(error);
            }

            const actions = document.createElement('div');
            actions.className = 'history-actions';
            const detailLink = document.createElement('a');
            detailLink.href = `/jobs/${item.job_id}`;
            detailLink.target = '_blank';
            detailLink.rel = 'noopener';
            detailLink.className = 'text-link';
            detailLink.textContent = 'æŸ¥çœ‹è¯¦æƒ…';
            actions.appendChild(detailLink);
            card.appendChild(actions);

            return card;
        };

        const setHistoryState = ({ loading = false, error = null }) => {
            if (loading) {
                historyEmpty.textContent = 'åŠ è½½ä¸­...';
                historyEmpty.hidden = false;
                historyList.hidden = true;
                historyError.hidden = true;
                return;
            }
            if (error) {
                historyError.textContent = error;
                historyError.hidden = false;
                historyEmpty.hidden = true;
                historyList.hidden = true;
                return;
            }
            historyError.hidden = true;
        };

        const loadHistory = async () => {
            setHistoryState({ loading: true });
            historyList.innerHTML = '';
            try {
                const res = await fetch('/api/history?limit=20', { cache: 'no-store' });
                if (res.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                if (!res.ok) throw new Error('å†å²è®°å½•æ‹‰å–å¤±è´¥');
                const items = await res.json();
                if (!items.length) {
                    historyEmpty.textContent = 'æš‚æ— å†å²ä»»åŠ¡';
                    historyEmpty.hidden = false;
                    historyList.hidden = true;
                    return;
                }
                historyList.hidden = false;
                historyEmpty.hidden = true;
                items.forEach(item => {
                    historyList.appendChild(renderHistoryCard(item));
                });
            } catch (err) {
                console.error(err);
                setHistoryState({ error: 'å†å²è®°å½•åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚' });
            }
        };

        historyRefresh.addEventListener('click', loadHistory);
        loadHistory();
    </script>
</body>
</html>
